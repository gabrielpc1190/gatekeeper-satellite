substitutions:
  name: "gatekeeper-xiao-3"
  wifi_ssid: "GADI_IoT"
  wifi_pass: "01012010"
  mqtt_broker: "172.16.9.20"

esphome:
  name: "${name}"

esp32:
  board: seeed_xiao_esp32c3
  framework:
    type: arduino

wifi:
  reboot_timeout: 5min
  fast_connect: false
  networks:
    - ssid: "${wifi_ssid}"
      password: "${wifi_pass}"
      manual_ip:
        static_ip: 172.16.9.123
        gateway: 172.16.9.1
        subnet: 255.255.255.0

mqtt:
  id: mqtt_client
  broker: "${mqtt_broker}"
  username: "gatekeeper_pi" 
  password: "gatekeeper_pi" 
  topic_prefix: gatekeeper/satellite/${name}
  reboot_timeout: 5min

api:
  password: "gatekeeper_api"

ota:
  - platform: esphome
    password: "gatekeeper_ota"

logger:
  level: INFO

web_server:
  port: 80

esp32_ble_tracker:
  scan_parameters:
    interval: 3000ms
    window: 100ms
    active: false
  on_ble_advertise:
    then:
      - lambda: |-
          static std::map<std::string, int> last_rssi_map;
          static std::map<std::string, uint32_t> last_send_map;
          
          char topic[256];
          char payload[128];
          std::string id_str;
          
          // Identifier Extraction
          if (x.get_ibeacon().has_value()) {
            auto beacon = x.get_ibeacon().value();
            std::string uuid_str = beacon.get_uuid().to_string();
            sprintf(topic, "gatekeeper/satellite/${name}/uuid/%s", uuid_str.c_str());
            sprintf(payload, "{\"rssi\": %d, \"major\": %d, \"minor\": %d}", 
                    x.get_rssi(), beacon.get_major(), beacon.get_minor());
            id_str = uuid_str;     
          } else {
            sprintf(topic, "gatekeeper/satellite/${name}/%s", x.address_str().c_str());
            sprintf(payload, "%d", x.get_rssi());
            id_str = x.address_str();
          }

          // Throttling Logic
          bool should_send = false;
          uint32_t now = millis();
          
          if (last_rssi_map.count(id_str) == 0) {
             should_send = true;
          } else {
             int last_rssi = last_rssi_map[id_str];
             if (abs(x.get_rssi() - last_rssi) >= 3) should_send = true; // 3dB Delta
             if (now - last_send_map[id_str] > 5000) should_send = true; // 5s Keepalive
          }

          if (should_send) {
            last_rssi_map[id_str] = x.get_rssi();
            last_send_map[id_str] = now;
            id(mqtt_client).publish(topic, payload);
          }
