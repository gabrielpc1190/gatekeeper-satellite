{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2 style="margin-bottom: 0.2rem;">Bluetooth Scanner</h2>
            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                <span
                    style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #10b981;"></span>
                <span style="color: #10b981; font-weight: 500;">Background Tracking Active</span>
            </div>
        </div>
        <a href="/" class="btn btn-ghost">Back to Dashboard</a>
    </div>

    <p style="color: var(--text-secondary); margin: 1rem 0;">
        Discover nearby Bluetooth devices and iBeacon UUIDs. Discovery runs in parallel with active tracking.
    </p>

    <!-- Progress Bar -->
    <div id="scanProgress"
        style="display: none; width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: 1rem; overflow: hidden;">
        <div id="scanProgressBar" style="width: 0%; height: 100%; background: #10b981; transition: width 0.3s;"></div>
    </div>

    <!-- Filter Controls -->
    <div
        style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-primary" id="scanBtn" onclick="toggleScan()">
                Start Live Discovery (120s)
            </button>

            <button class="btn btn-ghost" id="clearBtn" onclick="clearDiscoveryCache()"
                style="color: #ef4444; border-color: rgba(239, 68, 68, 0.2);">
                üóëÔ∏è Clear History
            </button>

            <label
                style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 4px;">
                <input type="checkbox" id="filterIBeacon" checked onchange="applyFilters()">
                <span>iBeacons</span>
            </label>

            <label
                style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 4px;">
                <input type="checkbox" id="filterBLE" checked onchange="applyFilters()">
                <span>BLE</span>
            </label>

            <label
                style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 4px;">
                <input type="checkbox" id="hideTracked" onchange="applyFilters()">
                <span>Hide Tracked</span>
            </label>
        </div>

        <div style="border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem;">
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">Filter
                by Satellite (Select many):</p>
            <div id="satelliteSelection" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <label id="btn-sat-all" class="sat-chip active" onclick="toggleSatelliteFilter('all')">
                    All Detectors
                </label>
                {% for sat in satellites %}
                <label id="btn-sat-{{ sat.id }}" class="sat-chip" onclick="toggleSatelliteFilter('{{ sat.id }}')">
                    {{ sat.name }}
                </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <style>
        .sat-chip {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            user-select: none;
        }

        .sat-chip:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sat-chip.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }
    </style>

    <script>
        let allDevices = [];
        let scanInterval = null;
        let scanRemaining = 0;
        const SCAN_DURATION = 120; // seconds

        function toggleScan() {
            if (scanInterval) {
                stopScan();
            } else {
                startScan();
            }
        }

        async function clearDiscoveryCache() {
            if (!confirm("This will clear all discovered devices from memory. Proceed?")) return;

            try {
                await fetch('/bluetooth/clear', { method: 'POST' });
                allDevices = [];
                renderDevices();
            } catch (err) {
                console.error("Clear failed", err);
            }
        }

        function startScan() {
            const btn = document.getElementById('scanBtn');
            const progress = document.getElementById('scanProgress');
            const bar = document.getElementById('scanProgressBar');

            btn.classList.add('btn-success');
            btn.style.backgroundColor = '#ef4444'; // Red for Stop
            btn.innerText = 'Stop Scanning';

            progress.style.display = 'block';
            bar.style.width = '0%';

            scanRemaining = SCAN_DURATION;

            // Initial fetch
            fetchScanResults();

            scanInterval = setInterval(() => {
                scanRemaining -= 2;
                const percent = ((SCAN_DURATION - scanRemaining) / SCAN_DURATION) * 100;
                bar.style.width = percent + '%';

                fetchScanResults();

                if (scanRemaining <= 0) {
                    stopScan();
                }
            }, 2000);
        }

        function stopScan() {
            const btn = document.getElementById('scanBtn');
            const progress = document.getElementById('scanProgress');

            clearInterval(scanInterval);
            scanInterval = null;

            btn.style.backgroundColor = '';
            btn.innerText = 'Start Live Discovery (120s)';
            progress.style.display = 'none';
        }

        function fetchScanResults() {
            fetch('/bluetooth/scan', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.results) {
                        allDevices = data.results;
                        renderDevices();
                    }
                })
                .catch(err => {
                    console.error("Scan fetch error", err);
                });
        }

        let selectedSatellites = new Set(['all']);

        function toggleSatelliteFilter(satId) {
            if (satId === 'all') {
                selectedSatellites.clear();
                selectedSatellites.add('all');
                document.querySelectorAll('.sat-chip').forEach(c => c.classList.remove('active'));
                document.getElementById('btn-sat-all').classList.add('active');
            } else {
                if (selectedSatellites.has('all')) {
                    selectedSatellites.delete('all');
                    document.getElementById('btn-sat-all').classList.remove('active');
                }

                if (selectedSatellites.has(satId)) {
                    selectedSatellites.delete(satId);
                    document.getElementById(`btn-sat-${satId}`).classList.remove('active');
                } else {
                    selectedSatellites.add(satId);
                    document.getElementById(`btn-sat-${satId}`).classList.add('active');
                }

                // If nothing selected, go back to all
                if (selectedSatellites.size === 0) {
                    selectedSatellites.add('all');
                    document.getElementById('btn-sat-all').classList.add('active');
                }
            }
            applyFilters();
        }

        function applyFilters() {
            renderDevices();
        }

        function renderDevices() {
            const tbody = document.getElementById('scanResultsBody');
            const showIBeacon = document.getElementById('filterIBeacon').checked;
            const showBLE = document.getElementById('filterBLE').checked;
            const hideTracked = document.getElementById('hideTracked').checked;

            const filtered = allDevices.filter(device => {
                if (!showIBeacon && device.type === 'ibeacon') return false;
                if (!showBLE && device.type === 'ble') return false;
                if (hideTracked && device.tracked) return false;

                // Satellite Filter Logic
                if (!selectedSatellites.has('all')) {
                    // Check if any of the device's sources match the selected satellites
                    const deviceSources = device.sources_detailed || [];
                    const matchesSat = deviceSources.some(s => {
                        // Note: sources_detailed in server.py uses the name or sid. 
                        // To be robust, let's matches against selected IDs.
                        // We need to pass the IDs in sources_detailed as well in server.py
                        return selectedSatellites.has(s.id);
                    });
                    if (!matchesSat) return false;
                }

                return true;
            });

            const devCountSpan = document.getElementById('deviceCount');
            if (devCountSpan) devCountSpan.innerText = filtered.length;

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color: var(--text-secondary);">No devices found.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            filtered.forEach(device => {
                const typeBadge = device.type === 'ibeacon' ?
                    '<span style="background: #10b981; color: white; padding: 3px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">iBeacon</span>' :
                    '<span style="background: #6366f1; color: white; padding: 3px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">BLE</span>';

                const statusBadge = device.tracked ?
                    '<span class="badge badge-success" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.5rem; border-radius: 4px;">‚úì Tracked</span>' :
                    '<span class="badge badge-warning" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 0.25rem 0.5rem; border-radius: 4px;">Not Tracked</span>';

                const identifier = device.type === 'ibeacon' ? device.uuid_short : device.mac;
                const identifierFull = device.type === 'ibeacon' ? device.uuid_full : device.mac;
                const displayName = device.type === 'ibeacon' ? `iBeacon ${device.major}/${device.minor}` : (device.name || 'Unknown');

                let actionCell = '';
                if (!device.tracked) {
                    const identifierType = device.type === 'ibeacon' ? 'uuid' : 'mac';
                    actionCell = `
                        <form action="/devices/add" method="post" style="margin:0; display:flex; gap:0.5rem; align-items:center;">
                            <input type="hidden" name="identifier" value="${identifierFull}">
                            <input type="hidden" name="identifier_type" value="${identifierType}">
                            <input type="text" name="alias" placeholder="Name..." required 
                                   style="padding:8px; border:1px solid #444; background:#222; color:white; border-radius:4px; width: 100px;">
                            <button type="submit" class="btn btn-primary" style="padding: 8px 12px;">Add</button>
                        </form>`;
                } else {
                    actionCell = '<span style="color: #888; font-style: italic;">Tracked</span>';
                }

                const sources = device.sources_detailed || [];
                sources.sort((a, b) => b.rssi - a.rssi);

                const sourceBadges = sources.map(s => {
                    const isSelected = selectedSatellites.has('all') || selectedSatellites.has(s.id);
                    const opacity = isSelected ? '1' : '0.3';
                    const bg = isSelected ? 'rgba(255,255,255,0.05)' : 'transparent';
                    const fontWeight = isSelected ? 'bold' : 'normal';

                    const color = s.name.includes('SalaTV-Cocina') ? '#3b82f6' : '#f59e0b';
                    return `
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px; min-width: 140px; opacity: ${opacity}; background: ${bg}; padding: 2px 4px; border-radius: 4px;">
                        <span style="color: ${color}; font-weight: 500;">${s.name}:</span>
                        <span style="color: var(--text-secondary); font-family: monospace; font-weight: ${fontWeight};">${s.rssi} dBm</span>
                    </div>`;
                }).join('');

                const row = `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 1rem;">${typeBadge}</td>
                    <td style="padding: 1rem; font-family: monospace; font-size: 0.9em;" title="${identifierFull}">${identifier}</td>
                    <td style="padding: 1rem;">${displayName}</td>
                    <td style="padding: 1rem; border-left: 1px solid rgba(255,255,255,0.05);">${sourceBadges}</td>
                    <td style="padding: 1rem; font-weight: bold;">${device.rssi} dBm</td>
                    <td style="padding: 1rem;">${statusBadge}</td>
                    <td style="padding: 1rem;">${actionCell}</td>
                </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    </script>

    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <th style="padding: 1rem;">Type</th>
                    <th style="padding: 1rem;">Identifier</th>
                    <th style="padding: 1rem;">Name / Info</th>
                    <th style="padding: 1rem; border-left: 1px solid rgba(255,255,255,0.05);">Detected By (Room : RSSI)
                    </th>
                    <th style="padding: 1rem;">Max RSSI</th>
                    <th style="padding: 1rem;">Status</th>
                    <th style="padding: 1rem; min-width: 200px; display: flex; align-items: center; justify-content: space-between;">
                        <span>Action</span>
                        <span id="deviceCount" style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: normal; color: var(--text-secondary);">0</span>
                    </th>
                </tr>
            </thead>
            <tbody id="scanResultsBody">
                <tr>
                    <td colspan="7" style="text-align:center; padding: 2rem; color: var(--text-secondary);">
                        Click "Start Live Discovery" to see devices in real-time.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}